<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Victor Bingwa Sokoni - Data & Minutes</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#006400',
            secondary: '#00a86b',
            accent: '#1e40af'
          },
          animation: {
            'fade-in': 'fadeIn 0.5s ease-in-out',
            'slide-up': 'slideUp 0.5s ease-out',
            'slide-down': 'slideDown 0.5s ease-out',
            'slide-left': 'slideLeft 0.5s ease-out',
            'slide-right': 'slideRight 0.5s ease-out',
            'scale-in': 'scaleIn 0.3s ease-out',
            'pulse-slow': 'pulse 2s infinite'
          },
          keyframes: {
            fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
            slideUp: { '0%': { transform: 'translateY(20px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } },
            slideDown: { '0%': { transform: 'translateY(-20px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } },
            slideLeft: { '0%': { transform: 'translateX(20px)', opacity: '0' }, '100%': { transform: 'translateX(0)', opacity: '1' } },
            slideRight: { '0%': { transform: 'translateX(-20px)', opacity: '0' }, '100%': { transform: 'translateX(0)', opacity: '1' } },
            scaleIn: { '0%': { transform: 'scale(0.9)', opacity: '0' }, '100%': { transform: 'scale(1)', opacity: '1' } }
          }
        }
      }
    }
  </script>

  <style>
    .animate-on-scroll { opacity: 0; transform: translateY(20px); transition: opacity 0.6s ease, transform 0.6s ease; }
    .animate-on-scroll.visible { opacity: 1; transform: translateY(0); }
    .tab-content { transition: opacity 0.3s ease, transform 0.3s ease; }
    .tab-content.hidden { display: none; }
    .tab-content.active { animation: slideUp 0.5s ease-out; }
  </style>
</head>
<body class="bg-gradient-to-br from-primary to-secondary min-h-screen flex flex-col items-center justify-center p-4">

  <!-- Loading -->
  <div id="loading-screen" class="fixed inset-0 bg-white z-50 flex flex-col items-center justify-center">
    <div class="w-16 h-16 border-4 border-primary border-t-transparent rounded-full animate-spin mb-4"></div>
    <h2 class="text-xl font-bold text-primary">Victor Bingwa Sokoni</h2>
    <p class="text-gray-600 mt-2">Loading premium mobile services...</p>
  </div>

  <div id="main-content" class="w-full max-w-2xl bg-white rounded-xl shadow-2xl overflow-hidden opacity-0 scale-95 transition-all duration-500">
    <!-- header -->
    <header class="bg-gradient-to-r from-primary to-secondary text-white p-6 text-center">
      <h1 class="text-2xl md:text-3xl font-bold flex items-center justify-center gap-3">
        <i class="fas fa-bolt"></i> VICTOR BINGWA SOKONI
      </h1>
      <p class="mt-2 text-lg font-medium">Premium Mobile Services</p>
      <p class="mt-1 opacity-90">Instant Data, Minutes & SMS Bundles</p>
    </header>

    <!-- tabs -->
    <div class="flex border-b">
      <button id="data-tab" class="tab-button flex-1 py-4 font-medium text-center bg-green-50 text-primary border-b-2 border-primary">DATA</button>
      <button id="minutes-tab" class="tab-button flex-1 py-4 font-medium text-center text-gray-600 hover:text-primary">MINUTES</button>
      <button id="sms-tab" class="tab-button flex-1 py-4 font-medium text-center text-gray-600 hover:text-primary">SMS</button>
    </div>

    <div class="p-4 md:p-6">
      <!-- offers container -->
      <div id="offers-container">
        <!-- DATA -->
        <div id="data-content" class="tab-content active">
          <h2 class="text-xl font-bold text-primary mb-4">Data Bundles</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <!-- offer example: we attach data attributes for clarity -->
            <div class="offer-card animate-on-scroll bg-white border border-gray-200 rounded-xl p-4 shadow-lg">
              <div class="flex justify-between items-start mb-2">
                <div>
                  <div class="text-2xl font-bold text-primary">1.25GB</div>
                  <div class="text-sm text-gray-600">Until midnight</div>
                </div>
                <div class="offer-amount text-xl font-bold text-primary">Sh 55</div>
              </div>
              <button class="purchase-btn w-full mt-3 bg-primary hover:bg-green-700 text-white py-2 rounded-lg font-medium" type="button"
                      data-type="data" data-name="1.25GB" data-amount="55">PURCHASE</button>
            </div>

            <div class="offer-card animate-on-scroll bg-white border border-gray-200 rounded-xl p-4 shadow-lg">
              <div class="flex justify-between items-start mb-2">
                <div>
                  <div class="text-2xl font-bold text-primary">1.5GB</div>
                  <div class="text-sm text-gray-600">3 hours</div>
                </div>
                <div class="offer-amount text-xl font-bold text-primary">Sh 50</div>
              </div>
              <button class="purchase-btn w-full mt-3 bg-primary hover:bg-green-700 text-white py-2 rounded-lg font-medium" type="button"
                      data-type="data" data-name="1.5GB" data-amount="50">PURCHASE</button>
            </div>

            <!-- (keep the rest of your data offers similarly) -->
            <div class="offer-card animate-on-scroll bg-white border border-gray-200 rounded-xl p-4 shadow-lg">
              <div class="flex justify-between items-start mb-2">
                <div>
                  <div class="text-2xl font-bold text-primary">1.2GB</div>
                  <div class="text-sm text-gray-600">30 days</div>
                </div>
                <div class="offer-amount text-xl font-bold text-primary">Sh 250</div>
              </div>
              <button class="purchase-btn w-full mt-3 bg-primary hover:bg-green-700 text-white py-2 rounded-lg font-medium" type="button"
                      data-type="data" data-name="1.2GB" data-amount="250">PURCHASE</button>
            </div>

            <div class="offer-card animate-on-scroll bg-white border border-gray-200 rounded-xl p-4 shadow-lg">
              <div class="flex justify-between items-start mb-2">
                <div>
                  <div class="text-2xl font-bold text-primary">350MB</div>
                  <div class="text-sm text-gray-600">1 week</div>
                </div>
                <div class="offer-amount text-xl font-bold text-primary">Sh 49</div>
              </div>
              <button class="purchase-btn w-full mt-3 bg-primary hover:bg-green-700 text-white py-2 rounded-lg font-medium" type="button"
                      data-type="data" data-name="350MB" data-amount="49">PURCHASE</button>
            </div>

            <div class="offer-card animate-on-scroll bg-white border border-gray-200 rounded-xl p-4 shadow-lg">
              <div class="flex justify-between items-start mb-2">
                <div>
                  <div class="text-2xl font-bold text-primary">1GB</div>
                  <div class="text-sm text-gray-600">1 hour</div>
                </div>
                <div class="offer-amount text-xl font-bold text-primary">Sh 19</div>
              </div>
              <button class="purchase-btn w-full mt-3 bg-primary hover:bg-green-700 text-white py-2 rounded-lg font-medium" type="button"
                      data-type="data" data-name="1GB (1 hour)" data-amount="19">PURCHASE</button>
            </div>

            <div class="offer-card animate-on-scroll bg-white border border-gray-200 rounded-xl p-4 shadow-lg">
              <div class="flex justify-between items-start mb-2">
                <div>
                  <div class="text-2xl font-bold text-primary">250MB</div>
                  <div class="text-sm text-gray-600">24 hours</div>
                </div>
                <div class="offer-amount text-xl font-bold text-primary">Sh 20</div>
              </div>
              <button class="purchase-btn w-full mt-3 bg-primary hover:bg-green-700 text-white py-2 rounded-lg font-medium" type="button"
                      data-type="data" data-name="250MB" data-amount="20">PURCHASE</button>
            </div>

            <div class="offer-card animate-on-scroll bg-white border border-gray-200 rounded-xl p-4 shadow-lg">
              <div class="flex justify-between items-start mb-2">
                <div>
                  <div class="text-2xl font-bold text-primary">1GB</div>
                  <div class="text-sm text-gray-600">24 hours</div>
                </div>
                <div class="offer-amount text-xl font-bold text-primary">Sh 99</div>
              </div>
              <button class="purchase-btn w-full mt-3 bg-primary hover:bg-green-700 text-white py-2 rounded-lg font-medium" type="button"
                      data-type="data" data-name="1GB (24h)" data-amount="99">PURCHASE</button>
            </div>

            <div class="offer-card animate-on-scroll bg-white border border-gray-200 rounded-xl p-4 shadow-lg">
              <div class="flex justify-between items-start mb-2">
                <div>
                  <div class="text-2xl font-bold text-primary">2GB</div>
                  <div class="text-sm text-gray-600">24 hours</div>
                </div>
                <div class="offer-amount text-xl font-bold text-primary">Sh 110</div>
              </div>
              <button class="purchase-btn w-full mt-3 bg-primary hover:bg-green-700 text-white py-2 rounded-lg font-medium" type="button"
                      data-type="data" data-name="2GB" data-amount="110">PURCHASE</button>
            </div>
          </div>
        </div>

        <!-- MINUTES -->
        <div id="minutes-content" class="tab-content hidden">
          <h2 class="text-xl font-bold text-primary mb-4">Voice Minutes</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="offer-card animate-on-scroll bg-white border border-gray-200 rounded-xl p-4 shadow-lg">
              <div class="flex justify-between items-start mb-2">
                <div>
                  <div class="text-2xl font-bold text-primary">45 mins</div>
                  <div class="text-sm text-gray-600">3 hours</div>
                </div>
                <div class="offer-amount text-xl font-bold text-primary">Sh 22</div>
              </div>
              <button class="purchase-btn w-full mt-3 bg-primary hover:bg-green-700 text-white py-2 rounded-lg font-medium" type="button"
                      data-type="minutes" data-name="45 mins" data-amount="22">PURCHASE</button>
            </div>

            <div class="offer-card animate-on-scroll bg-white border border-gray-200 rounded-xl p-4 shadow-lg">
              <div class="flex justify-between items-start mb-2">
                <div>
                  <div class="text-2xl font-bold text-primary">50 mins</div>
                  <div class="text-sm text-gray-600">Until midnight</div>
                </div>
                <div class="offer-amount text-xl font-bold text-primary">Sh 51</div>
              </div>
              <button class="purchase-btn w-full mt-3 bg-primary hover:bg-green-700 text-white py-2 rounded-lg font-medium" type="button"
                      data-type="minutes" data-name="50 mins" data-amount="51">PURCHASE</button>
            </div>
          </div>
        </div>

        <!-- SMS -->
        <div id="sms-content" class="tab-content hidden">
          <h2 class="text-xl font-bold text-primary mb-4">SMS Bundles</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="offer-card animate-on-scroll bg-white border border-gray-200 rounded-xl p-4 shadow-lg">
              <div class="flex justify-between items-start mb-2">
                <div>
                  <div class="text-2xl font-bold text-primary">200 SMS</div>
                  <div class="text-sm text-gray-600">Valid for 24 hours</div>
                </div>
                <div class="offer-amount text-xl font-bold text-primary">Sh 10</div>
              </div>
              <button class="purchase-btn w-full mt-3 bg-primary hover:bg-green-700 text-white py-2 rounded-lg font-medium" type="button"
                      data-type="sms" data-name="200 SMS" data-amount="10">PURCHASE</button>
            </div>

            <div class="offer-card animate-on-scroll bg-white border border-gray-200 rounded-xl p-4 shadow-lg">
              <div class="flex justify-between items-start mb-2">
                <div>
                  <div class="text-2xl font-bold text-primary">20 SMS</div>
                  <div class="text-sm text-gray-600">Valid for 1 day</div>
                </div>
                <div class="offer-amount text-xl font-bold text-primary">Sh 5</div>
              </div>
              <button class="purchase-btn w-full mt-3 bg-primary hover:bg-green-700 text-white py-2 rounded-lg font-medium" type="button"
                      data-type="sms" data-name="20 SMS" data-amount="5">PURCHASE</button>
            </div>
   <div class="offer-card animate-on-scroll bg-white border border-gray-200 rounded-xl p-4 shadow-lg">
              <div class="flex justify-between items-start mb-2">
                <div>
                  <div class="text-2xl font-bold text-primary">1500 SMS</div>
                  <div class="text-sm text-gray-600">Valid for 1 month</div>
                </div>
                <div class="offer-amount text-xl font-bold text-primary">Sh 101</div>
              </div>
              <button class="purchase-btn w-full mt-3 bg-primary hover:bg-green-700 text-white py-2 rounded-lg font-medium" type="button"
                      data-type="sms" data-name="1500 SMS" data-amount="101">PURCHASE</button>
            </div>
               <div class="offer-card animate-on-scroll bg-white border border-gray-200 rounded-xl p-4 shadow-lg">
              <div class="flex justify-between items-start mb-2">
                <div>
                  <div class="text-2xl font-bold text-primary">3500SMS</div>
                  <div class="text-sm text-gray-600">Valid for 1 month</div>
                </div>
                <div class="offer-amount text-xl font-bold text-primary">Sh 201</div>
              </div>
              <button class="purchase-btn w-full mt-3 bg-primary hover:bg-green-700 text-white py-2 rounded-lg font-medium" type="button"
                      data-type="sms" data-name="3500 SMS" data-amount="201">PURCHASE</button>
            </div>
            <div class="offer-card animate-on-scroll bg-white border border-gray-200 rounded-xl p-4 shadow-lg">
              <div class="flex justify-between items-start mb-2">
                <div>
                  <div class="text-2xl font-bold text-primary">1000 SMS</div>
                  <div class="text-sm text-gray-600">Valid for 7 days</div>
                </div>
                <div class="offer-amount text-xl font-bold text-primary">Sh 30</div>
              </div>
              <button class="purchase-btn w-full mt-3 bg-primary hover:bg-green-700 text-white py-2 rounded-lg font-medium" type="button"
                      data-type="sms" data-name="1000 SMS" data-amount="30">PURCHASE</button>
            </div>
          </div>
        </div>
      </div>

      <!-- phone input -->
      <div id="phone-input-section" class="mt-6 p-6 bg-gradient-to-br from-gray-50 to-white rounded-xl shadow-xl hidden">
        <h3 class="text-xl font-bold text-primary mb-4 flex items-center gap-2"><i class="fas fa-mobile-alt"></i> Complete Your Purchase</h3>
        <div class="mb-6">
          <div id="selected-offer" class="bg-green-50 p-4 rounded-lg mb-4 border border-green-200"></div>
          <label class="block text-gray-700 mb-2 font-medium" for="phone">Enter Your Phone Number</label>
          <input type="text" id="phone" placeholder="e.g., 07xxx or 011xxx or 254xxx"
                 class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary">
          <p class="text-xs text-gray-500 mt-2">We'll automatically process your offer purchase upon successful transaction</p>
        </div>

        <div class="flex gap-3">
          <button id="confirm-purchase" class="flex-1 bg-primary hover:bg-green-700 text-white py-3 rounded-lg font-medium flex items-center justify-center gap-2" type="button">
            <i class="fas fa-lock"></i> Continue
          </button>
          <button id="cancel-purchase" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-3 rounded-lg font-medium flex items-center justify-center gap-2" type="button">
            <i class="fas fa-times"></i> Cancel
          </button>
        </div>
      </div>

      <!-- transaction status -->
      <div id="transaction-status" class="mt-6 p-6 bg-gradient-to-br from-gray-50 to-white rounded-xl shadow-xl hidden">
        <h3 class="text-xl font-bold text-primary mb-4 flex items-center gap-2"><i class="fas fa-receipt"></i> Transaction Status</h3>
        <div class="mb-6">
          <div id="status-message" class="text-center py-6 rounded-lg"></div>
        </div>
        <button id="new-purchase" class="w-full bg-primary hover:bg-green-700 text-white py-3 rounded-lg font-medium" type="button">
          <i class="fas fa-shopping-cart"></i> Make New Purchase
        </button>
      </div>

    </div>

    <!-- footer -->
    <footer class="bg-gray-100 p-4 text-center text-gray-600">
      <p class="font-bold text-accent">
        <a href="https://portfolio.giftedtech.co.ke" target="_blank" class="hover:underline">Powered by Victor Ngetich 
        email:victorngetich376@gmail.com  
        helpline:0743272507</a>
      </p>
      <p class="mt-2 text-sm">Stay connected - Bingwa Sokoni got you 24/7!</p>
      <div class="mt-3 flex flex-wrap justify-center gap-3">
        <span class="text-primary font-medium">#DataDeals</span>
        <span class="text-primary font-medium">#Minutes</span>
        <span class="text-primary font-medium">#Safaricom</span>
        <span class="text-primary font-medium">#BingwaSokoni</span>
      </div>
    </footer>
  </div>

  <!-- notification -->
  <div id="notification" class="fixed top-4 right-4 p-4 rounded-lg shadow-lg text-white font-medium transform translate-x-full transition-transform duration-300 z-50"></div>

  <script>
    (function () {
      const API_BASE_URL = "https://mpesa-stk.giftedtech.co.ke";
      let selectedOffer = null;

      // small helper
      function $(sel, root = document) { return root.querySelector(sel); }
      function $all(sel, root = document) { return Array.from(root.querySelectorAll(sel)); }

      // show/hide loading -> main
      function finishLoading() {
        document.getElementById('loading-screen').classList.add('hidden');
        const main = document.getElementById('main-content');
        main.classList.remove('opacity-0', 'scale-95');
        main.classList.add('opacity-100', 'scale-100');
        initScrollAnimations();
      }

      // notifications
      function showNotification(msg, type = 'success') {
        const n = document.getElementById('notification');
        n.textContent = msg;
        n.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg text-white font-medium transform translate-x-full transition-transform duration-300 z-50 ${
          type === 'error' ? 'bg-red-500' : type === 'info' ? 'bg-blue-500' : 'bg-green-500'
        }`;
        setTimeout(() => n.classList.remove('translate-x-full'), 100);
        setTimeout(() => n.classList.add('translate-x-full'), 3000);
      }

      // phone formatting
      function formatPhoneNumber(phone) {
        phone = (phone || '').replace(/\D/g, '');
        if (phone.startsWith('0')) return '254' + phone.substring(1);
        if ((phone.length === 9 && (phone.startsWith('7') || phone.startsWith('1')))) return '254' + phone;
        return phone;
      }

      // scroll animations
      function initScrollAnimations() {
        const observer = new IntersectionObserver(entries => {
          entries.forEach(e => { if (e.isIntersecting) e.target.classList.add('visible'); });
        }, { threshold: 0.1 });
        $all('.animate-on-scroll').forEach(el => observer.observe(el));
      }

      // tab switching
      function initTabs() {
        $all('.tab-button').forEach(btn => {
          btn.addEventListener('click', () => {
            $all('.tab-button').forEach(b => {
              b.classList.remove('bg-green-50', 'text-primary', 'border-primary');
              b.classList.add('text-gray-600');
            });
            btn.classList.add('bg-green-50', 'text-primary', 'border-primary');
            btn.classList.remove('text-gray-600');

            $all('.tab-content').forEach(c => { c.classList.add('hidden'); c.classList.remove('active'); });
            const id = btn.id.replace('-tab', '-content');
            const active = document.getElementById(id);
            if (active) {
              active.classList.remove('hidden');
              setTimeout(() => active.classList.add('active'), 50);
              setTimeout(initScrollAnimations, 300);
            }
          });
        });
      }

      // purchase delegation: safer and works for any dynamically added buttons
      function initPurchaseDelegation() {
        const offersContainer = document.getElementById('offers-container');

        // handle clicks on any purchase button inside offersContainer
        offersContainer.addEventListener('click', (ev) => {
          const btn = ev.target.closest && ev.target.closest('.purchase-btn');
          if (!btn) return;
          ev.preventDefault();

          // read data attributes first (prefer them)
          const dataType = btn.getAttribute('data-type') || 'unknown';
          const dataName = btn.getAttribute('data-name') || (btn.closest('.offer-card')?.querySelector('.text-2xl')?.textContent || 'Offer');
          const dataAmount = btn.getAttribute('data-amount') || (btn.closest('.offer-card')?.querySelector('.offer-amount')?.textContent.replace(/[^\d]/g, '') || '');

          if (!dataAmount) {
            showNotification('Offer amount not found', 'error');
            return;
          }

          selectedOffer = {
            type: dataType,
            description: dataName.trim(),
            amount: dataAmount.toString().trim()
          };

          // update UI and show phone input
          document.getElementById('selected-offer').innerHTML = `
            <div class="flex justify-between items-center">
              <div>
                <div class="font-bold text-lg text-primary">${selectedOffer.description}</div>
                <div class="text-sm text-gray-600">${dataType.toUpperCase()}</div>
              </div>
              <div class="text-xl font-bold text-primary">Sh ${selectedOffer.amount}</div>
            </div>
          `;
          document.getElementById('offers-container').classList.add('hidden');
          document.getElementById('phone-input-section').classList.remove('hidden');
          document.getElementById('transaction-status').classList.add('hidden');
          $('#phone').value = '';
        });
      }

      // cancel / new purchase
      function initCancelAndNew() {
        $('#cancel-purchase').addEventListener('click', () => {
          document.getElementById('offers-container').classList.remove('hidden');
          document.getElementById('phone-input-section').classList.add('hidden');
          selectedOffer = null;
        });

        $('#new-purchase').addEventListener('click', () => {
          document.getElementById('transaction-status').classList.add('hidden');
          document.getElementById('offers-container').classList.remove('hidden');
          selectedOffer = null;
          $('#phone').value = '';
        });
      }

      // confirm purchase -> call API and poll status
      function initConfirmPurchase() {
        $('#confirm-purchase').addEventListener('click', async function () {
          if (!selectedOffer) {
            showNotification('No offer selected. Please choose an offer first.', 'error');
            return;
          }

          const phoneRaw = $('#phone').value.trim();
          if (!phoneRaw) { showNotification('Please enter your phone number', 'error'); return; }

          const formatted = formatPhoneNumber(phoneRaw);
          if (!formatted.startsWith('254') || formatted.length !== 12) {
            showNotification('Please enter a valid phone number (e.g., 0712345678 or 0111234567)', 'error');
            return;
          }

          const btn = this;
          btn.disabled = true;
          btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Processing...';

          try {
            const resp = await fetch(`${API_BASE_URL}/api/payVictorN.php`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ phoneNumber: formatted, amount: selectedOffer.amount, description: selectedOffer.description, type: selectedOffer.type })
            });

            const data = await resp.json().catch(() => null);
            if (!data) {
              showNotification('Invalid response from payment server', 'error');
              console.error('Empty JSON response', resp);
              return;
            }

            if (data.success) {
              showNotification('STK Push sent successfully! Check your phone', 'success');
              document.getElementById('phone-input-section').classList.add('hidden');

              document.getElementById('transaction-status').classList.remove('hidden');
              document.getElementById('status-message').innerHTML = `
                <div class="flex flex-col items-center">
                  <i class="fas fa-check-circle text-green-500 text-4xl mb-2"></i>
                  <p class="font-medium">STK Push sent to ${formatted}</p>
                  <p class="text-sm text-gray-600 mt-1">Enter M-Pesa PIN to complete</p>
                  <div class="mt-4 w-12 h-12 border-4 border-primary border-t-transparent rounded-full animate-spin"></div>
                </div>
              `;

              // start polling using the CheckoutRequestID (guarded)
              if (data.CheckoutRequestID) pollTransactionStatus(data.CheckoutRequestID);
              else console.warn('No CheckoutRequestID received -- cannot poll status.');
            } else {
              showNotification('Failed to send STK Push: ' + (data.error || 'Unknown'), 'error');
              console.error('Payment API returned failure:', data);
            }
          } catch (err) {
            console.error('Error initiating payment:', err);
            showNotification('Error initiating payment: ' + (err.message || err), 'error');
          } finally {
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-lock"></i> Continue';
          }
        });
      }

      // polling function (keeps interval id local)
      function pollTransactionStatus(checkoutRequestId) {
        let attempts = 0;
        const maxAttempts = 300;
        const statusBox = document.getElementById('status-message');
        let intervalId = null;

        const poll = async () => {
          attempts++;
          if (attempts > maxAttempts) {
            clearInterval(intervalId);
            statusBox.innerHTML = `<div class="text-center"><i class="fas fa-clock text-yellow-500 text-4xl mb-2"></i>
              <p>Transaction timeout. Check your M-Pesa messages.</p></div>`;
            return;
          }

          try {
            const res = await fetch(`${API_BASE_URL}/api/verify-transaction.php`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ checkoutRequestId })
            });
            const data = await res.json().catch(() => null);
            if (!data) { console.warn('Empty verify response'); return; }

            // If we have a final ResultDesc or final status, stop polling and show message
            if (data.data?.ResultDesc || data.status === 'completed' || data.status === 'failed') {
              clearInterval(intervalId);
              if (data.status === 'completed' || (data.data && data.data.ResultDesc && data.status === 'completed')) {
                statusBox.innerHTML = `<div class="flex flex-col items-center">
                  <i class="fas fa-check-circle text-green-500 text-4xl mb-2"></i>
                  <p class="font-medium">Payment Completed!</p>
                  <p class="text-sm text-gray-600 mt-1">${data.data?.ResultDesc || 'Transaction successful'}</p>
                  <p class="text-sm font-medium mt-2">Code: ${data.data?.MpesaReceiptNumber || 'N/A'}</p>
                </div>`;
                showNotification('Payment completed successfully!', 'success');
              } else {
                statusBox.innerHTML = `<div class="flex flex-col items-center">
                  <i class="fas fa-times-circle text-red-500 text-4xl mb-2"></i>
                  <p class="font-medium">Payment Failed</p>
                  <p class="text-sm text-gray-600 mt-1">${data.data?.ResultDesc || 'Transaction failed'}</p>
                </div>`;
                showNotification('Payment failed', 'error');
              }
            }
          } catch (err) {
            console.error('poll error', err);
          }
        };

        intervalId = setInterval(poll, 1000);
        // call immediately once
        poll();
      }

      // initialization on DOM ready
      document.addEventListener('DOMContentLoaded', () => {
        // hide loading after a short delay to simulate spinner
        setTimeout(finishLoading, 500);

        initTabs();
        initPurchaseDelegation();
        initCancelAndNew();
        initConfirmPurchase();
      });
    })();
  </script>
</body>
</html>
